---
description: 
globs: 
alwaysApply: false
---
# Cours Complet : Int√©gration de l'API Sendcloud pour D√©veloppeurs #

Bienvenue dans ce guide complet pour l'int√©gration de Sendcloud via son API RESTful. Que vous ayez une boutique en ligne sur mesure, un ERP ou un WMS, ce cours vous donnera les cl√©s pour automatiser enti√®rement votre processus d'exp√©dition.

## 1\. Introduction √† l'API Sendcloud

Sendcloud est une plateforme tout-en-un qui simplifie le processus d'exp√©dition pour les e-commer√ßants. Alors que de nombreuses plateformes e-commerce peuvent se connecter via des plugins "plug-and-play", l'**API Sendcloud** offre une flexibilit√© maximale pour une int√©gration personnalis√©e.

### **Pourquoi utiliser l'API ?**

  * **Flexibilit√© Totale** : Concevez votre propre flux de travail logistique, de la cr√©ation des commandes √† l'impression des √©tiquettes.
  * **Int√©gration sur Mesure** : Int√©grez les fonctionnalit√©s de Sendcloud directement dans votre syst√®me existant (ERP, WMS, application custom).
  * **Acc√®s Modulaire** : Utilisez uniquement les briques dont vous avez besoin. Vous pouvez g√©rer les colis via l'API tout en utilisant l'interface (le "Panel") Sendcloud pour la configuration.

### **Les diff√©rentes APIs Sendcloud**

L'√©cosyst√®me Sendcloud se compose de plusieurs APIs sp√©cialis√©es :

  * **Shipping API** : Le c≈ìur du syst√®me. Cr√©ez des √©tiquettes, comparez les tarifs, et g√©n√©rez des documents douaniers.
  * **Service Points API** : Int√©grez une carte de s√©lection de points relais dans votre checkout.
  * **Returns API** : Permettez √† vos clients de g√©n√©rer leurs propres √©tiquettes de retour.
  * **Tracking API** : R√©cup√©rez l'historique de suivi d√©taill√© d'un colis.
  * **Dynamic Checkout API** : Proposez des options de livraison pr√©cises (lendemain, jour-m√™me) directement sur votre page de paiement.

-----

## 2\. D√©marrage et Authentification

Avant de pouvoir effectuer votre premier appel API, une configuration initiale est n√©cessaire.

### **Pr√©requis**

1.  **Cr√©ez un compte Sendcloud** : Suivez les √©tapes de base pour configurer votre compte.
2.  **Configurez vos adresses** : Ajoutez au moins une adresse d'exp√©diteur et de retour.
3.  **Activez des transporteurs** : Dans votre Panel, allez dans `Param√®tres > Transporteurs & Tarifs` pour activer les transporteurs que vous souhaitez utiliser.
4.  **Configurez une m√©thode de paiement** : Indispensable pour la cr√©ation d'√©tiquettes payantes.

### **Obtenir vos Cl√©s API (Authentification)**

Sendcloud utilise une **Authentification Basique (Basic Authentication)**. Vous aurez besoin d'une cl√© publique et d'une cl√© secr√®te.

**√âtapes pour g√©n√©rer vos cl√©s :**

1.  Connectez-vous √† votre compte Sendcloud.
2.  Allez dans `Param√®tres > Int√©grations`.
3.  Trouvez **"Sendcloud API"** dans la liste et cliquez sur `Connecter`.
4.  Donnez un nom √† votre int√©gration (ex: "Mon ERP") et sauvegardez.
5.  Vos cl√©s **Publique (Public Key)** et **Secr√®te (Secret Key)** seront g√©n√©r√©es.

\<br\>
üö® **Important** : Copiez et conservez votre cl√© secr√®te en lieu s√ªr. Elle n'est visible qu'une seule fois. Si vous la perdez, vous devrez en g√©n√©rer une nouvelle, ce qui invalidera l'ancienne.

### **Comment s'authentifier**

Chaque requ√™te API doit contenir un en-t√™te `Authorization`. La valeur de cet en-t√™te est le mot `Basic` suivi d'un jeton encod√© en Base64. Ce jeton est la concat√©nation de votre cl√© publique, deux-points (`:`), et votre cl√© secr√®te.

**Format** : `PublicKey:SecretKey`

**Exemple en cURL :**
La commande `curl` g√®re l'encodage pour vous avec l'option `--user`.

```bash
curl "https://panel.sendcloud.sc/api/v2/parcels" \
  --user "VOTRE_CLE_PUBLIQUE:VOTRE_CLE_SECRETE"
```

**Exemple en Python avec la biblioth√®que `requests`:**
La biblioth√®que `requests` g√®re √©galement l'encodage automatiquement.

```python
import requests

public_key = "VOTRE_CLE_PUBLIQUE"
private_key = "VOTRE_CLE_SECRETE"

response = requests.get(
    'https://panel.sendcloud.sc/api/v2/parcels',
    auth=(public_key, private_key)
)

print(response.json())
```

*Note : Sendcloud d√©ploie √©galement l'authentification OAuth2, qui est actuellement en phase b√™ta.*

-----

## 3\. Le Coeur de l'API : Cr√©er un Colis et une √âtiquette

Le flux le plus courant est la cr√©ation d'un colis (`parcel`) et de son √©tiquette (`label`).

### **√âtape 1 : Cr√©er un objet "Parcel" (sans √©tiquette)**

Cette premi√®re √©tape enregistre le colis dans Sendcloud sans encore le d√©clarer au transporteur. Cela vous laisse le temps de le modifier ou de choisir la m√©thode d'envoi.

On utilise le point de terminaison `POST /api/v2/parcels` avec le param√®tre **`request_label` √† `false`**.

**Exemple de requ√™te (corps JSON) :**

```json
{
    "parcel": {
        "name": "John Doe",
        "company_name": "Ma Boutique",
        "address": "Rue de la R√©publique",
        "house_number": "10",
        "city": "Paris",
        "postal_code": "75001",
        "country": "FR",
        "email": "client@example.com",
        "telephone": "+33612345678",
        "weight": "1.5",
        "parcel_items": [
            {
                "description": "T-Shirt Bleu",
                "quantity": 1,
                "weight": "0.5",
                "value": "25.00",
                "sku": "TS-BL-M",
                "hs_code": "610910",
                "origin_country": "PT"
            }
        ],
        "request_label": false,
        "apply_shipping_rules": true
    }
}
```

*Notez le `hs_code` (code douanier) et `origin_country`, qui sont cruciaux pour l'international.*

**R√©ponse de l'API :**
Si la requ√™te r√©ussit, vous recevrez un statut `HTTP 200` et une r√©ponse contenant l'objet `parcel` cr√©√©, avec son **`id` unique**. Le statut du colis sera `"No label"`.

### **√âtape 2 : Mettre √† jour le colis pour cr√©er l'√©tiquette**

Une fois que vous √™tes pr√™t √† exp√©dier, vous mettez √† jour le colis pour demander la cr√©ation de l'√©tiquette.

On utilise le point de terminaison `PUT /api/v2/parcels` en fournissant l'**`id` du colis** et en passant **`request_label` √† `true`**. Vous pouvez aussi en profiter pour sp√©cifier ou changer la m√©thode d'envoi (`shipment`).

**Exemple de requ√™te (corps JSON) :**

```json
{
    "parcel": {
        "id": 189169249, // L'ID obtenu √† l'√©tape 1
        "request_label": true,
        "shipment": {
            "id": 8 // ID de la m√©thode "Unstamped letter" pour les tests
        }
    }
}
```

**R√©ponse de l'API :**
La r√©ponse contiendra l'objet `parcel` mis √† jour. Son statut sera pass√© √† `"Ready to send"` et un **num√©ro de suivi (`tracking_number`)** aura √©t√© assign√©. Plus important encore, l'objet `label` contiendra les URLs pour t√©l√©charger votre √©tiquette.

### **√âtape 3 : T√©l√©charger l'√©tiquette**

L'objet `label` dans la r√©ponse contient des liens pour t√©l√©charger le PDF, g√©n√©ralement au format A6 (pour imprimantes √† √©tiquettes) et A4.

```json
"label": {
    "normal_printer": [
        "https://panel.sendcloud.sc/api/v2/labels/normal_printer/189169249?start_from=0"
    ],
    "label_printer": "https://panel.sendcloud.sc/api/v2/labels/label_printer/189169249"
}
```

Pour t√©l√©charger le fichier, effectuez une requ√™te `GET` sur l'URL de votre choix, en utilisant la m√™me authentification que pour les autres appels.

-----

## 4\. G√©rer les Sc√©narios d'Exp√©dition Sp√©cifiques

### **Exp√©dition Internationale**

Pour les envois hors UE, des documents douaniers sont obligatoires. Sendcloud les g√©n√®re automatiquement si vous fournissez les bonnes informations lors de la cr√©ation du colis.

**Champs obligatoires dans `parcel_items` :**

  * `description`: Description claire du produit.
  * `quantity`: Quantit√©.
  * `weight`: Poids en kg.
  * `value`: Valeur de l'article.
  * **`hs_code`**: Le code du Syst√®me Harmonis√© (code douanier) √† 6-8 chiffres.
  * **`origin_country`**: Le pays d'origine du produit (code ISO 2, ex: "FR", "CN").

La r√©ponse pour un envoi international r√©ussi inclura un objet `documents` contenant les liens vers l'√©tiquette (`label`) et la facture commerciale (`commercial-invoice`).

### **Exp√©ditions Multicolis (Multicollo)**

Pour envoyer plusieurs colis dans un seul envoi, vous avez deux options principales :

1.  **Avec l'API Parcels v2 (plus simple)** :
    Lors de la cr√©ation du colis, utilisez le champ `quantity` pour sp√©cifier le nombre de colis. Sendcloud cr√©era autant d'√©tiquettes avec le m√™me num√©ro de commande.

    ```json
    "parcel": {
        // ... autres champs
        "quantity": 3,
        "request_label": true
    }
    ```

2.  **Avec l'API Shipments v3 (plus flexible et recommand√©e)** :
    Cette API plus r√©cente permet de sp√©cifier les dimensions, le poids et le contenu pour *chaque colis* individuellement dans un tableau `parcels`, ce qui est plus pr√©cis et peut r√©duire les surco√ªts.

-----

## 5\. Tester et Automatiser votre Workflow

### **Cr√©er des √âtiquettes de Test**

Pour tester votre int√©gration sans √™tre factur√©, utilisez la m√©thode d'envoi **"Unstamped letter"** (Lettre non affranchie). Son `id` est g√©n√©ralement `8`.

  * R√©cup√©rez la liste des m√©thodes d'envoi (`GET /api/v2/shipping_methods`) pour vous assurer de l'ID.
  * Utilisez cet ID lors de la cr√©ation de l'√©tiquette.

### **Annuler une √âtiquette**

Vous pouvez annuler une √©tiquette (si le transporteur le permet) avant une certaine heure limite (g√©n√©ralement 23:59 le jour de la cr√©ation).

  * **Endpoint** : `POST /api/v2/parcels/{id}/cancel`
  * **R√©ponse** : `{ "status": "cancelled" }`

Si vous annulez une √©tiquette apr√®s la date limite mais qu'elle n'est pas utilis√©e, le co√ªt vous sera g√©n√©ralement rembours√© sur votre facture suivante.

### **G√©rer les Limites de Taux (Rate Limiting)**

Pour assurer la stabilit√© de la plateforme, l'API Sendcloud impose des limites sur le nombre de requ√™tes :

  * **Requ√™tes "s√ªres" (GET)** : 1000 requ√™tes / minute.
  * **Requ√™tes "non s√ªres" (POST, PUT, DELETE)** : 100 requ√™tes / minute.

Si vous d√©passez ces limites, l'API r√©pondra avec un code d'erreur `HTTP 429 Too Many Requests`. Assurez-vous de g√©rer cette erreur dans votre code, par exemple en impl√©mentant un m√©canisme de pause et de nouvelle tentative (`retry-after`).

-----

## 6\. Glossaire des Termes Cl√©s

  * **Parcel (Colis)** : Un objet de donn√©es contenant toutes les informations n√©cessaires pour une livraison (adresses, poids, contenu). C'est l'entit√© de base pour cr√©er une √©tiquette.
  * **Shipment (Exp√©dition)** : Un objet de donn√©es qui repr√©sente une commande import√©e d'une int√©gration (comme Shopify). Un *shipment* peut √™tre transform√© en *parcel*.
  * **Label (√âtiquette)** : Le document g√©n√©r√© pour le transporteur, contenant les adresses, le code-barres de suivi, etc.
  * **Multicollo** : Un envoi compos√© de plusieurs colis distincts, tous li√©s et annonc√©s en m√™me temps.
  * **HS Code (Code SH)** : Code douanier international utilis√© pour classifier les produits lors des exp√©ditions internationales.



## 7. R√©cup√©rer les M√©thodes d'Envoi et les Tarifs

Pour cr√©er une √©tiquette, vous devez sp√©cifier la m√©thode d'envoi. Plut√¥t que de coder en dur des identifiants, il est essentiel de les r√©cup√©rer dynamiquement via l'API.

üö® **Important** : Les ID des m√©thodes d'envoi (`shipping_method_id`) sont volatils. Ne les mettez jamais en cache pour plus d'une heure.

### **Obtenir la Liste des M√©thodes d'Envoi**

Pour obtenir la liste des m√©thodes d'envoi disponibles en fonction des transporteurs que vous avez activ√©s et de votre adresse d'exp√©diteur, utilisez le point de terminaison `GET /api/v2/shipping_methods`.

**Facteurs influen√ßant la r√©ponse :**
* Les transporteurs activ√©s dans votre compte.
* Vos contrats transporteurs directs (si vous en avez).
* L'adresse d'exp√©diteur (`sender_address`). Si non sp√©cifi√©e, l'adresse par d√©faut est utilis√©e.

**Exemple de requ√™te (pour une adresse d'exp√©diteur en France) :**
```bash
curl --location --request GET 'https://panel.sendcloud.sc/api/v2/shipping_methods?sender_address=ID_ADRESSE_FRANCE' \
--user "VOTRE_CLE_PUBLIQUE:VOTRE_CLE_SECRETE"
```

**R√©ponse (extrait) :**
```json
{
    "shipping_methods": [
        {
            "id": 1490,
            "name": "Chrono Classic 23-24kg",
            "carrier": "chronopost",
            "min_weight": "23.001",
            "max_weight": "24.001",
            "price": 0, // Le prix de base, consulter l'objet 'countries' pour le d√©tail
            "countries": [
                {
                    "id": 1,
                    "name": "Belgium",
                    "price": 40.0,
                    "iso_2": "BE"
                }
            ]
        }
    ]
}
```
Vous utiliserez l'**`id`** (ici, `1490`) dans vos requ√™tes de cr√©ation de colis.

### **Filtrer les M√©thodes d'Envoi**

* **Pour les retours** : Ajoutez le param√®tre `is_return=true`.
* **Pour la livraison en point relais** : Ajoutez le param√®tre `service_point_id={id_du_point_relais}`.

### **Obtenir les Tarifs d'Exp√©dition**

Pour conna√Ætre le prix d'un envoi sp√©cifique sans cr√©er de colis, utilisez le point de terminaison `GET /api/v2/shipping-price`.

**Param√®tres requis :**
* `shipping_method_id` : L'ID de la m√©thode.
* `from_country` : Pays d'exp√©dition.
* `to_country` : Pays de destination.
* `weight` : Poids du colis.
* `weight_unit` : `kilogram` ou `gram`.

**Exemple de requ√™te :**
```bash
curl "https://panel.sendcloud.sc/api/v2/shipping-price?shipping_method_id=3&from_country=NL&to_country=FR&weight=2&weight_unit=kilogram" \
--user "VOTRE_CLE_PUBLIQUE:VOTRE_CLE_SECRETE"
```

**R√©ponse :**
```json
[
    {
        "price": "12.00",
        "currency": "EUR",
        "to_country": "FR"
    }
]
```

---

## 8. Automatiser et Optimiser Votre Workflow

### **Les R√®gles d'Exp√©dition (Shipping Rules)**

Les r√®gles d'exp√©dition, configur√©es dans le Panel Sendcloud, sont un puissant outil d'automatisation. Elles permettent d'appliquer des actions (ex: "exp√©dier avec Colissimo", "assurer pour 100‚Ç¨") en fonction de conditions (ex: "si le pays est l'Espagne", "si le poids est > 5kg").

Vous pouvez d√©clencher ces r√®gles via l'API en passant le param√®tre **`apply_shipping_rules` √† `true`** lors de la cr√©ation d'un colis.

**Comment √ßa marche :**
1.  Cr√©ez une r√®gle dans votre Panel. Par exemple : `SI [Pays de destination] est [Pays-Bas], ALORS [Exp√©dier avec] [PostNL Standard]`.
2.  Lors de la cr√©ation du colis via l'API, envoyez la requ√™te avec `apply_shipping_rules: true`.
3.  M√™me si vous sp√©cifiez une autre m√©thode d'envoi dans la requ√™te, la r√®gle aura la priorit√© et appliquera `PostNL Standard`.

C'est une excellente fa√ßon de centraliser votre logique m√©tier dans le Panel Sendcloud tout en utilisant l'API pour pousser les commandes.

### **Planifier des Enl√®vements (Pickups)**

Si vous avez besoin qu'un transporteur vienne collecter vos colis, vous pouvez planifier un enl√®vement ponctuel via `POST /api/v3/pickups`.

**Exemple de requ√™te pour un enl√®vement :**
```json
{
    "address": {
        "name": "John Doe",
        "company_name": "Mon Entreprise",
        "country_code": "FR",
        "city": "Paris",
        "address_line_1": "10 Rue du Faubourg Saint-Honor√©",
        "postal_code": "75008",
        "phone_number": "+33123456789"
    },
    "time_slots": [
        {
            "start_at": "2025-06-18T12:00:00Z",
            "end_at": "2025-06-18T17:00:00Z"
        }
    ],
    "items": [
        {
            "quantity": 20,
            "container_type": "parcel",
            "total_weight": { "value": "15.00", "unit": "kg" }
        }
    ],
    "carrier_code": "dhl_express"
}
```

### **Utiliser Pack & Go**

Pour les entrep√¥ts √† haut volume, vous pouvez utiliser l'API pour cr√©er des centaines de colis avec `request_label: false`. Ces colis appara√Ætront dans l'interface "Pack & Go" du Panel Sendcloud, o√π les op√©rateurs pourront simplement scanner les bons de pr√©paration pour imprimer les √©tiquettes en masse.

---

## 9. G√©rer les Retours

Une bonne gestion des retours est cruciale. Sendcloud propose plusieurs fa√ßons de les automatiser via l'API. La plus compl√®te est l'**API du Portail de Retour**.

### **Le Flux de l'API du Portail de Retour**

Cette API est con√ßue pour que vous puissiez construire votre propre page de retour personnalis√©e. Elle utilise une authentification **JWT** temporaire, car elle peut √™tre expos√©e √† vos clients finaux.

1.  **Rechercher le colis sortant** : Le client saisit son code postal et son num√©ro de suivi (ou de commande) sur votre portail. Vous utilisez ces informations pour appeler `GET /api/v2/brand/{brand_domain}/return-portal/outgoing`.
2.  **Obtenir un jeton d'acc√®s** : Si la recherche est fructueuse, l'API retourne les d√©tails du colis original ainsi que deux jetons : `access_token` (pour cr√©er le retour) et `service_points_token` (pour chercher des points de d√©p√¥t).
3.  **Cr√©er le retour** : Utilisez l'`access_token` pour appeler `POST /brand/{brand_domain}/return-portal/incoming`. Dans cette requ√™te, vous sp√©cifiez la raison du retour et la m√©thode choisie par le client.
4.  **T√©l√©charger l'√©tiquette de retour** : La r√©ponse contient une URL de "polling". Vous devez interroger cette URL jusqu'√† ce qu'elle retourne un statut `200 OK` avec le fichier PDF de l'√©tiquette.

### **Les Diff√©rentes M√©thodes de Retour**

Dans la requ√™te de cr√©ation de retour, vous pouvez sp√©cifier la `delivery_option` :
* `"drop_off_point"`: Le client d√©pose le colis dans un point relais.
* `"pickup"`: Un transporteur vient chercher le colis chez le client.
* `"in_store"`: Le client retourne l'article dans un de vos magasins physiques (pas d'√©tiquette g√©n√©r√©e).
* `"drop_off_labelless"`: Le client re√ßoit un QR code √† pr√©senter au point de d√©p√¥t, sans avoir besoin d'imprimer l'√©tiquette.

---

## 10. Int√©grer les Points Relais (Service Points)

Offrir la livraison en point relais am√©liore la satisfaction client. Voici comment l'int√©grer.

1.  **Activer les points relais** : Dans les param√®tres de votre int√©gration API dans le Panel Sendcloud, cochez la case "Activer les points relais" et s√©lectionnez les transporteurs concern√©s.
2.  **Rechercher des points relais** : Utilisez `GET /api/v2/service-points` pour trouver les points relais proches d'une adresse ou d'un code postal.
    ```bash
    curl "https://servicepoints.sendcloud.sc/api/v2/service-points?country=FR&postal_code=75001&radius=2000"
    ```
3.  **Obtenir les m√©thodes d'envoi compatibles** : La r√©ponse vous donne une liste de points relais, chacun avec un `id` unique. Utilisez cet `id` pour trouver les m√©thodes d'envoi qui peuvent livrer √† ce point sp√©cifique.
    ```bash
    curl "https://panel.sendcloud.sc/api/v2/shipping_methods/?service_point_id=10659026"
    ```
4.  **Cr√©er le colis** : Effectuez votre appel `POST /api/v2/parcels` en incluant :
    * L'ID du point relais dans le champ `to_service_point`.
    * L'ID de la m√©thode d'envoi compatible dans l'objet `shipment`.

---

## 11. Suivre Vos Colis (Tracking)

Avec l'API Tracking, vous pouvez r√©cup√©rer l'historique complet d'un colis et l'afficher dans votre propre interface.

* **Endpoint** : `GET /api/v2/tracking/{tracking_number}`
* **R√©ponse** : Vous recevrez un objet JSON contenant les informations du colis et un tableau `statuses` avec chaque √©tape du suivi, de l'annonce (`announcing`) √† la livraison (`delivered`). Le champ `parent_status` standardise les statuts des diff√©rents transporteurs.

En alternative, vous pouvez simplement utiliser le lien `sendcloud_tracking_url` fourni dans la r√©ponse, qui redirige vers la page de suivi personnalisable de Sendcloud.

---

## 12. Pour les Marketplaces : Quel Mod√®le d'Int√©gration Choisir ?

Sendcloud propose des mod√®les sp√©cifiques si vous √™tes une marketplace.

* **Mod√®le Centralis√©**
    * **Qui ?** La marketplace poss√®de un seul compte Sendcloud.
    * **Comment ?** Elle cr√©e les √©tiquettes pour le compte de ses vendeurs via l'API, en utilisant les champs `from_address_*` pour sp√©cifier l'adresse du vendeur.
    * **Avantages :** Contr√¥le total, branding unifi√©, facturation centralis√©e. Id√©al pour les marketplaces C2C.

* **Mod√®le D√©centralis√©**
    * **Qui ?** Chaque vendeur a son propre compte Sendcloud.
    * **Comment ?** La marketplace se connecte √† l'API de chaque vendeur (via leurs cl√©s API) pour simplement pousser les commandes dans leur compte Sendcloud (`request_label: false`). Le vendeur g√®re ensuite ses envois depuis son propre Panel.
    * **Avantages :** Tr√®s scalable, moins de support pour la marketplace, les vendeurs peuvent utiliser leurs propres contrats transporteurs. Id√©al pour les marketplaces B2B/B2C avec des vendeurs √† fort volume.

* **Mod√®le Hybride**
    * Un m√©lange des deux. Offre la simplicit√© du mod√®le centralis√© pour les petits vendeurs et la flexibilit√© du mod√®le d√©centralis√© pour les gros vendeurs. C'est la solution la plus compl√®te mais aussi la plus complexe √† d√©velopper.

---

## 13. API v3 et le Futur : l'API Orders

Sendcloud d√©veloppe activement sa **V3 de l'API**, qui est plus structur√©e et s√©pare mieux les concepts. Le flux principal devient :

1.  **Cr√©er une Commande** : D'abord, vous cr√©ez une entit√© "Commande" avec toutes ses informations (produits, adresses, etc.) via `POST /api/v3/orders`.
2.  **Exp√©dier la Commande** : Ensuite, vous appelez un point de terminaison d√©di√© pour cr√©er l'√©tiquette pour cette commande existante, soit de mani√®re asynchrone (pour les lots), soit synchrone (pour une seule √©tiquette).

Ce mod√®le est plus robuste et est la direction que prend Sendcloud pour le futur.
